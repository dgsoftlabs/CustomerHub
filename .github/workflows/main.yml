name: Build and Deploy to AWS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      enable_deploy:
        description: 'Enable deployment to AWS'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '20'
  # AWS Configuration
  AWS_REGION: 'us-east-1'

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Build application
        run: npm run build
        env:
          DATABASE_URL: ./local.db

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            .next/
            public/
            package.json
            package-lock.json
          retention-days: 7

  deploy:
    name: Deploy to AWS
    needs: build
    runs-on: ubuntu-latest
    # Deploy only if:
    # 1. Manual workflow with enable_deploy=true OR
    # 2. Auto-deploy is enabled (set AUTO_DEPLOY variable in repo settings to 'true')
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.enable_deploy == 'true') ||
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && vars.AUTO_DEPLOY == 'true')
    
    # Uncomment for specific environment
    # environment:
    #   name: production
    #   url: https://your-app.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # Option 1: Deploy to AWS Amplify
      - name: Deploy to AWS Amplify
        if: ${{ vars.DEPLOY_TARGET == 'amplify' }}
        run: |
          echo "Deploying to AWS Amplify..."
          # Install Amplify CLI
          npm install -g @aws-amplify/cli
          # Deploy (configure amplify init first in your project)
          # amplify publish --yes

      # Option 2: Deploy to AWS S3 + CloudFront
      - name: Deploy to S3
        if: ${{ vars.DEPLOY_TARGET == 's3' || vars.DEPLOY_TARGET == '' }}
        run: |
          echo "Deploying to AWS S3..."
          # Export static Next.js site
          npm run build
          # Sync to S3 bucket
          aws s3 sync .next/static s3://${{ secrets.AWS_S3_BUCKET }}/_next/static --delete
          aws s3 sync public s3://${{ secrets.AWS_S3_BUCKET }}/public --delete
          # Invalidate CloudFront cache (if using CloudFront)
          if [ -n "${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            aws cloudfront create-invalidation \
              --distribution-id ${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID }} \
              --paths "/*"
          fi

      # Option 3: Deploy to AWS ECS (Docker)
      - name: Login to Amazon ECR
        if: ${{ vars.DEPLOY_TARGET == 'ecs' }}
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        if: ${{ vars.DEPLOY_TARGET == 'ecs' }}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: Deploy to ECS
        if: ${{ vars.DEPLOY_TARGET == 'ecs' }}
        run: |
          # Update ECS service with new image
          aws ecs update-service \
            --cluster ${{ secrets.ECS_CLUSTER }} \
            --service ${{ secrets.ECS_SERVICE }} \
            --force-new-deployment

      - name: Deployment Summary
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "Environment: ${{ vars.DEPLOY_TARGET || 's3' }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Commit: ${{ github.sha }}"

